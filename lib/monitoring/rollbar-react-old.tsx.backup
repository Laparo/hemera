/**
 * Rollbar React Provider following official Next.js documentation
 * https://docs.rollbar.com/docs/nextjs
 */

'use client';

import { Provider as RollbarProvider } from '@rollbar/react';
import React from 'react';
import { clientConfig } from './rollbar-official';

interface RollbarProviderWrapperProps {
  children: React.ReactNode;
}

export function RollbarProviderWrapper({ children }: RollbarProviderWrapperProps) {
  return (
    <RollbarProvider config={clientConfig}>
      {children}
    </RollbarProvider>
  );
}
export function reportClientError(
  error: Error | string,
  context?: ClientErrorContext,
  severity: 'critical' | 'error' | 'warning' | 'info' | 'debug' = 'error'
): void {
  if (!clientRollbar || !clientRollbarConfig.enabled) {
    console.error('Client Rollbar Error (disabled):', error, context);
    return;
  }

  try {
    const rollbarContext = {
      person: context?.userId
        ? {
            id: context.userId,
            email: context.userEmail,
          }
        : undefined,

      custom: {
        component: context?.component,
        route: context?.route,
        timestamp: context?.timestamp?.toISOString(),
        url:
          context?.url ||
          (typeof window !== 'undefined' ? window.location.href : ''),
        userAgent:
          context?.userAgent ||
          (typeof window !== 'undefined' ? navigator.userAgent : ''),
        ...context?.additionalData,
      },
    };

    // Report based on severity
    switch (severity) {
      case 'critical':
        clientRollbar.critical(error, rollbarContext);
        break;
      case 'error':
        clientRollbar.error(error, rollbarContext);
        break;
      case 'warning':
        clientRollbar.warning(error, rollbarContext);
        break;
      case 'info':
        clientRollbar.info(error, rollbarContext);
        break;
      case 'debug':
        clientRollbar.debug(error, rollbarContext);
        break;
      default:
        clientRollbar.error(error, rollbarContext);
    }
  } catch (rollbarError) {
    console.error('Failed to report client error to Rollbar:', rollbarError);
    console.error('Original error:', error);
  }
}

/**
 * Report React component errors
 */
export function reportComponentError(
  error: Error,
  componentName: string,
  context?: ClientErrorContext
): void {
  reportClientError(
    error,
    {
      ...context,
      component: componentName,
      additionalData: {
        reactError: true,
        componentName,
        ...context?.additionalData,
      },
    },
    'error'
  );
}

/**
 * Report user interactions for analytics
 */
export function recordClientUserAction(
  action: string,
  userId?: string,
  metadata?: Record<string, any>
): void {
  if (!clientRollbar || !clientRollbarConfig.enabled) return;

  try {
    clientRollbar.info(`Client User Action: ${action}`, {
      person: userId ? { id: userId } : undefined,
      custom: {
        action,
        userAction: true,
        clientSide: true,
        timestamp: new Date().toISOString(),
        url: typeof window !== 'undefined' ? window.location.href : '',
        ...metadata,
      },
    });
  } catch (error) {
    console.error('Failed to record client user action:', error);
  }
}

/**
 * Rollbar Provider Component for Next.js App
 * Wrap your app with this component to enable Rollbar error tracking
 */
interface RollbarProviderWrapperProps {
  children: React.ReactNode;
  config?: Rollbar.Configuration;
}

export function RollbarProviderWrapper({
  children,
  config,
}: RollbarProviderWrapperProps) {
  const rollbarInstance = React.useMemo(() => {
    if (typeof window === 'undefined') return null;
    return new Rollbar(config || clientRollbarConfig);
  }, [config]);

  if (!rollbarInstance || !clientRollbarConfig.enabled) {
    return <>{children}</>;
  }

  return (
    <RollbarProvider instance={rollbarInstance}>{children}</RollbarProvider>
  );
}

/**
 * Enhanced Error Boundary with Rollbar Integration (Simplified)
 */
interface RollbarErrorBoundaryWrapperProps {
  children: React.ReactNode;
  fallbackUI?: React.ComponentType<{
    error: Error | null;
    resetError: () => void;
  }>;
  context?: Record<string, any>;
}

export function RollbarErrorBoundaryWrapper({
  children,
  fallbackUI: FallbackComponent,
  context = {},
}: RollbarErrorBoundaryWrapperProps) {
  const defaultFallback = ({
    error,
    resetError,
  }: {
    error: Error | null;
    resetError: () => void;
  }) => (
    <div
      style={{
        padding: '20px',
        border: '1px solid #ccc',
        borderRadius: '4px',
        margin: '10px',
      }}
    >
      <h2>Etwas ist schiefgelaufen</h2>
      <p>
        Ein unerwarteter Fehler ist aufgetreten:{' '}
        {error?.message || 'Unbekannter Fehler'}
      </p>
      <button onClick={resetError}>Versuchen Sie es erneut</button>
    </div>
  );

  return (
    <RollbarErrorBoundary fallbackUI={FallbackComponent || defaultFallback}>
      {children}
    </RollbarErrorBoundary>
  );
}

/**
 * Simple hook to report errors to Rollbar
 */
export function useRollbarError() {
  return React.useCallback((error: Error, context?: ClientErrorContext) => {
    reportClientError(error, context);
  }, []);
}

// Export client rollbar instance for direct use if needed
export { clientRollbar };

// Environment validation
if (
  typeof window !== 'undefined' &&
  isProduction &&
  !process.env.NEXT_PUBLIC_ROLLBAR_CLIENT_ACCESS_TOKEN
) {
  console.warn(
    '⚠️  NEXT_PUBLIC_ROLLBAR_CLIENT_ACCESS_TOKEN not set in production environment'
  );
}
